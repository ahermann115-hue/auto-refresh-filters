name: Daily Filter Update

on:
  schedule:
    - cron: '0 0 * * *'  # Daily at midnight UTC
  workflow_dispatch:      # Manual trigger

jobs:
  update:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.AUTO_UPDATE_TOKEN }}
          ref: main

      - name: ðŸ” Check token
        run: |
          if [ -z "${{ secrets.AUTO_UPDATE_TOKEN }}" ]; then
            echo "ERROR: AUTO_UPDATE_TOKEN not set!"
            exit 1
          fi
          echo "Token is available"

      - name: ðŸ Setup Python
        run: |
          python3 --version
          pip install mmh3 bitarray --quiet

      - name: ðŸ”§ Setup permissions
        run: |
          chmod +x update.sh

      - name: ðŸš€ Run update script
        id: run_update
        run: |
          ./update.sh
          
          if [ -f "blacklist.txt" ]; then
            DOMAIN_COUNT=$(grep -v '^#' blacklist.txt | grep -c '\.')
            echo "DOMAIN_COUNT=${DOMAIN_COUNT}" >> $GITHUB_OUTPUT
          fi
          
          if [ -f "bloom_filter.bin" ]; then
            BLOOM_SIZE=$(stat -c%s bloom_filter.bin)
            BLOOM_SIZE_KB=$((BLOOM_SIZE / 1024))
            echo "BLOOM_SIZE_KB=${BLOOM_SIZE_KB}" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ“ Commit and Push Files
        env:
          GH_TOKEN: ${{ secrets.AUTO_UPDATE_TOKEN }}
        run: |
          echo "Starting commit process..."
          
          # Setup git
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          
          # Add files
          git add bloom_filter.bin blacklist.txt README.md filtered.txt filtered_clean.txt 2>/dev/null || true
          
          # Commit if changes
          if ! git diff --cached --quiet; then
            echo "Creating commit..."
            
            # Get data
            DOMAIN_COUNT=${DOMAIN_COUNT:-$(grep -v '^#' blacklist.txt | grep -c '\.' 2>/dev/null || echo "0")}
            BLOOM_SIZE_KB=${BLOOM_SIZE_KB:-$(($(stat -c%s bloom_filter.bin 2>/dev/null || echo 0) / 1024))}
            DATE=$(date +'%Y-%m-%d')
            
            # SIMPLE ONE-LINE COMMIT MESSAGE - no line breaks!
            git commit -m "Auto update ${DATE} - ${DOMAIN_COUNT} domains, ${BLOOM_SIZE_KB} KB filter"
            
            echo "Pushing changes..."
            git push "https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git" HEAD:main
            
            echo "SUCCESS! Files updated."
          else
            echo "No changes to commit"
          fi
          
          echo "Workflow completed"

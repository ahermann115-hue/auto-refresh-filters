name: Daily Filter Update

on:
  schedule:
    - cron: '0 0 * * *'  # –ï–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ –ø–æ–ª–Ω–æ—á—å (–±—ã–ª–æ –Ω–∞–ø–∏—Å–∞–Ω–æ "–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ", –Ω–æ cron - –µ–∂–µ–¥–Ω–µ–≤–Ω–æ)
  workflow_dispatch:      # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

jobs:
  update:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.AUTO_UPDATE_TOKEN }}
          ref: main

      - name: üêç Setup Python
        run: |
          python3 --version
          pip install mmh3 bitarray --quiet

      - name: üîß Setup permissions
        run: |
          chmod +x update.sh
          echo "–°–∫—Ä–∏–ø—Ç –≥–æ—Ç–æ–≤ –∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é"

      - name: üöÄ Run update script
        id: run_update
        run: |
          echo "–ó–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞ update.sh..."
          ./update.sh
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–∞–∑–º–µ—Ä–µ —Ñ–∞–π–ª–æ–≤ –¥–ª—è –∫–æ–º–º–∏—Ç–∞
          if [ -f "blacklist.txt" ]; then
            DOMAIN_COUNT=$(grep -v '^#' blacklist.txt | grep -c '\.')
            echo "domains_count=${DOMAIN_COUNT}" >> $GITHUB_OUTPUT
          fi
          
          if [ -f "bloom_filter.bin" ]; then
            BLOOM_SIZE=$(stat -c%s bloom_filter.bin)
            BLOOM_SIZE_KB=$((BLOOM_SIZE / 1024))
            echo "bloom_size_kb=${BLOOM_SIZE_KB}" >> $GITHUB_OUTPUT
          fi

      - name: üìù Commit and Push Files
        env:
          GH_TOKEN: ${{ secrets.AUTO_UPDATE_TOKEN }}
        run: |
          echo "üîÑ –ù–∞—á–∏–Ω–∞–µ–º –∫–æ–º–º–∏—Ç..."
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∞–π–ª—ã
          echo "üìÅ –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:"
          ls -lh bloom_filter.bin blacklist.txt || true
          
          # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º git
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          
          # –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∞–π–ª—ã
          git add bloom_filter.bin blacklist.txt README.md
          
          echo "üìä –°—Ç–∞—Ç—É—Å git:"
          git status --short
          
          # –ö–æ–º–º–∏—Ç–∏–º –µ—Å–ª–∏ –µ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
          if ! git diff --cached --quiet; then
            echo "üíæ –°–æ–∑–¥–∞–µ–º –∫–æ–º–º–∏—Ç..."
            
            # –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å–∫—Ä–∏–ø—Ç–∞
            DOMAIN_COUNT=${DOMAIN_COUNT:-$(grep -v '^#' blacklist.txt | grep -c '\.' 2>/dev/null || echo "0")}
            BLOOM_SIZE_KB=${BLOOM_SIZE_KB:-$(($(stat -c%s bloom_filter.bin 2>/dev/null || echo 0) / 1024))}
            DATE=$(date +'%Y-%m-%d')
            
            git commit -m "ü§ñ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞ ${DATE}
            
‚Ä¢ –î–æ–º–µ–Ω–æ–≤ –≤ blacklist.txt: ${DOMAIN_COUNT}
‚Ä¢ –†–∞–∑–º–µ—Ä bloom_filter.bin: ${BLOOM_SIZE_KB} KB
‚Ä¢ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ: StevenBlack + BlockList Project
            
üìä –ò—Å—Ç–æ—á–Ω–∏–∫–∏:
- StevenBlack/hosts (fakenews-gambling-porn + malware)
- BlockList Project (drugs + weapons + violence)"
            
            echo "üöÄ –ü—É—à–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è..."
            git push "https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git" HEAD:main
            
            echo "‚úÖ –£–°–ü–ï–•! –§–∞–π–ª—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã."
          else
            echo "‚ÑπÔ∏è –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
          fi
          
          echo "üéâ –†–ê–ë–û–¢–ê –ó–ê–í–ï–†–®–ï–ù–ê"

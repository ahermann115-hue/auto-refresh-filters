name: Weekly Filter Update

on:
  schedule:
    - cron: '0 0 * * 0'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout with PAT
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.AUTO_UPDATE_TOKEN }}
          ref: main

      - name: üîß Setup
        run: |
          chmod +x update.sh
          echo "–¢–æ–∫–µ–Ω —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: ${{ secrets.AUTO_UPDATE_TOKEN != '' }}"
          echo "–†–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"
          ls -la

      - name: üìù Commit and Push Files
        env:
          GH_TOKEN: ${{ secrets.AUTO_UPDATE_TOKEN }}
        run: |
          # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º git
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          
          echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã..."
          ls -la blacklist.*
          
          # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º
          files_to_add=""
          commit_message="ü§ñ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ $(date +'%Y-%m-%d %H:%M:%S')\n\n"
          
          # 1. –í—Å–µ–≥–¥–∞ –¥–æ–±–∞–≤–ª—è–µ–º blacklist.txt –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
          if [ -f "blacklist.txt" ]; then
            txt_lines=$(grep -c '^[^#]' blacklist.txt || echo "0")
            if [ "$txt_lines" -gt 0 ]; then
              files_to_add="$files_to_add blacklist.txt"
              commit_message="$commit_messageüìù TXT: $txt_lines –¥–æ–º–µ–Ω–æ–≤\n"
              echo "‚úÖ –î–æ–±–∞–≤–ª—è–µ–º blacklist.txt ($txt_lines –¥–æ–º–µ–Ω–æ–≤)"
            fi
          fi
          
          # 2. –î–æ–±–∞–≤–ª—è–µ–º blacklist.bin –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
          if [ -f "blacklist.bin" ]; then
            bin_size=$(stat -c%s blacklist.bin 2>/dev/null || stat -f%z blacklist.bin)
            if [ "$bin_size" -gt 8 ]; then
              files_to_add="$files_to_add blacklist.bin"
              commit_message="$commit_messageüî¢ BIN: $bin_size –±–∞–π—Ç\n"
              echo "‚úÖ –î–æ–±–∞–≤–ª—è–µ–º blacklist.bin ($bin_size –±–∞–π—Ç)"
            else
              echo "‚ö†Ô∏è blacklist.bin —Å–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–∏–π ($bin_size –±–∞–π—Ç), –ø—Ä–æ–ø—É—Å–∫–∞–µ–º"
            fi
          else
            echo "‚ÑπÔ∏è blacklist.bin –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º"
          fi
          
          echo ""
          echo "üìÅ –§–∞–π–ª—ã –¥–ª—è –∫–æ–º–º–∏—Ç–∞: $files_to_add"
          
          if [ -z "$files_to_add" ]; then
            echo "‚ùå –ù–µ—Ç —Ñ–∞–π–ª–æ–≤ –¥–ª—è –∫–æ–º–º–∏—Ç–∞!"
            exit 1
          fi
          
          # 3. –ï—Å–ª–∏ .bin —Ñ–∞–π–ª–∞ –ù–ï–¢ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏, –Ω–æ –º—ã –µ–≥–æ —Å–æ–∑–¥–∞–ª–∏ - –æ—Å–æ–±—ã–π —Å–ª—É—á–∞–π
          if [ -f "blacklist.bin" ] && ! git ls-files blacklist.bin > /dev/null 2>&1; then
            echo "üÜï blacklist.bin - –Ω–æ–≤—ã–π —Ñ–∞–π–ª –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏"
            # –°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤–ª—è–µ–º –±–µ–∑ –∫–æ–º–º–∏—Ç–∞, —á—Ç–æ–±—ã —Ñ–∞–π–ª –ø–æ—è–≤–∏–ª—Å—è –≤ –∏–Ω–¥–µ–∫—Å–µ
            git add blacklist.bin
          fi
          
          # 4. –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ —Ñ–∞–π–ª—ã
          echo "‚ûï –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∞–π–ª—ã –≤ git..."
          for file in $files_to_add; do
            if [ -f "$file" ]; then
              git add "$file"
              echo "   ‚úì $file"
            fi
          done
          
          # 5. –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è
          if git diff --cached --quiet; then
            echo "‚ÑπÔ∏è –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∫–æ–º–º–∏—Ç"
          else
            echo "üìù –°–æ–∑–¥–∞–µ–º –∫–æ–º–º–∏—Ç..."
            
            # –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º
            echo -e "$commit_message" > commit_msg.txt
            
            # –ö–æ–º–º–∏—Ç–∏–º
            git commit -F commit_msg.txt
            
            # –ü—É—à–∏–º
            echo "üöÄ –ü—É—à–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è..."
            git push "https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git" HEAD:main
            
            echo ""
            echo "‚úÖ –£–°–ü–ï–®–ù–û –û–ë–ù–û–í–õ–ï–ù–û!"
            echo "====================="
            echo "üìÑ blacklist.txt: https://raw.githubusercontent.com/${{ github.repository }}/main/blacklist.txt"
            if [ -f "blacklist.bin" ]; then
              echo "üíæ blacklist.bin: https://raw.githubusercontent.com/${{ github.repository }}/main/blacklist.bin"
            fi
            
            rm -f commit_msg.txt
          fi

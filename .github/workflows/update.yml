name: Weekly Filter Update

on:
  schedule:
    - cron: '0 0 * * 0'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout with PAT
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.AUTO_UPDATE_TOKEN }}
          ref: main

      - name: üîß Setup
        run: |
          chmod +x update.sh
          echo "–¢–æ–∫–µ–Ω —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: ${{ secrets.AUTO_UPDATE_TOKEN != '' }}"
          echo "–†–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"
          ls -la

      - name: üöÄ Run update script
        run: ./update.sh

      - name: üìù Commit and Push BLACKLIST ONLY
        env:
          GH_TOKEN: ${{ secrets.AUTO_UPDATE_TOKEN }}
        run: |
          # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º git
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          
          # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –í–°–ï –∏–∑–º–µ–Ω–µ–Ω–∏—è, –∫—Ä–æ–º–µ blacklist.txt
          git checkout -- update.sh whitelist.txt
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–∑–º–µ–Ω–∏–ª—Å—è –ª–∏ blacklist.txt
          if git diff --quiet blacklist.txt; then
            echo "‚ÑπÔ∏è Blacklist –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∫–æ–º–º–∏—Ç"
          else
            echo "üîÑ Blacklist –∏–∑–º–µ–Ω–∏–ª—Å—è, –∫–æ–º–º–∏—Ç–∏–º..."
            git add blacklist.txt
            git commit -m "ü§ñ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ blacklist $(date +'%Y-%m-%d %H:%M:%S')"
            
            # –ü—É—à–∏–º —Ç–æ–ª—å–∫–æ blacklist
            git push "https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git" HEAD:main
            echo "‚úÖ –£—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—à–∏–ª–∏ blacklist!"
          fi

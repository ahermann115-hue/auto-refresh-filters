name: Weekly Filter Update

on:
  schedule:
    - cron: '0 0 * * 0'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout with PAT
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.AUTO_UPDATE_TOKEN }}
          ref: main

      - name: üîß Setup
        run: |
          chmod +x update.sh
          echo "–¢–æ–∫–µ–Ω —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: ${{ secrets.AUTO_UPDATE_TOKEN != '' }}"
          echo "–†–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"
          ls -la

      - name: üìù Commit and Push BOTH FILES
        env:
          GH_TOKEN: ${{ secrets.AUTO_UPDATE_TOKEN }}
        run: |
          # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º git
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          
          # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ª–∏—à–Ω–∏–µ —Ñ–∞–π–ª—ã
          git checkout -- update.sh 2>/dev/null || true
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∫–∏–µ —Ñ–∞–π–ª—ã –∏–∑–º–µ–Ω–∏–ª–∏—Å—å
          echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è..."
          
          # –í—Å–µ–≥–¥–∞ –¥–æ–±–∞–≤–ª—è–µ–º –æ–±–∞ —Ñ–∞–π–ª–∞ (–±–∏–Ω–∞—Ä–Ω—ã–π –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–æ–≤—ã–π)
          git add blacklist.txt blacklist.bin
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è
          if git diff --cached --quiet; then
            echo "‚ÑπÔ∏è –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ blacklist, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∫–æ–º–º–∏—Ç"
          else
            echo "üîÑ –ò–∑–º–µ–Ω–µ–Ω–∏—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã, —Å–æ–∑–¥–∞–µ–º –∫–æ–º–º–∏—Ç..."
            
            # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            txt_lines=$(wc -l < blacklist.txt | tr -d ' ')
            bin_size=$(stat -c%s blacklist.bin 2>/dev/null || stat -f%z blacklist.bin)
            
            # –ö–æ–º–º–∏—Ç
            git commit -m "ü§ñ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ $(date +'%Y-%m-%d')
            
            üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:
            ‚Ä¢ TXT: $txt_lines –¥–æ–º–µ–Ω–æ–≤
            ‚Ä¢ BIN: $bin_size –±–∞–π—Ç
            ‚Ä¢ –í—Å–µ–≥–¥–∞ –∞–∫—Ç—É–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è"
            
            # –ü—É—à–∏–º
            git push "https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git" HEAD:main
            
            echo "‚úÖ –£—Å–ø–µ—à–Ω–æ! –û–±–∞ —Ñ–∞–π–ª–∞ –æ–±–Ω–æ–≤–ª–µ–Ω—ã."
            echo "   üëâ TXT: https://raw.githubusercontent.com/${{ github.repository }}/main/blacklist.txt"
            echo "   üëâ BIN: https://raw.githubusercontent.com/${{ github.repository }}/main/blacklist.bin"
          fi
